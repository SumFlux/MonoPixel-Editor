# 产品需求文档 (PRD): MonoPixel Editor v1.0

## 1. 项目概况

* **项目名称**：MonoPixel Editor
* **开发目标**：构建一个基于 Python (PyQt6) 的单色像素画编辑与取模工具，专用于嵌入式 OLED/LCD 开发。
* **核心特性**：1-bit 颜色深度、多图层支持、特殊的半宽字体渲染、多种取模格式导出。
* **技术栈**：
* 语言：Python 3.10+
* GUI 框架：PyQt6
* 数据处理：NumPy (处理位运算与数组)
* 字体处理：Freetype / QFont (通过 Qt 接口)



## 2. 界面与视图逻辑

### 2.1 画布属性

* **尺寸**：默认 `104 x 212` px（竖屏）。
* 限制：最小 `1x1`，最大 `999x999`。
* 修改尺寸：支持调整画布大小（Resize Canvas），默认以左上角 `(0,0)` 为锚点，向右/下扩展或裁剪。


* **颜色定义**：
* **黑色 (Foreground)**：逻辑 `1` (默认)。
* **白色/透明 (Background)**：逻辑 `0` (默认)。


* **网格线**：
* 开关：工具栏提供按钮手动开关。
* 逻辑：覆盖在画布最上层的非交互层，不参与导出。


* **缩放与平移**：
* 滚轮：以鼠标为中心缩放。
* 中键/空格+左键：拖拽平移画布。



## 3. 核心功能详解

### 3.1 绘图工具箱

所有绘图操作仅在**当前选中图层**生效。

1. **画笔 (Pencil)**：绘制黑色像素。支持笔触大小（1px, 2px, 3px...）。
2. **橡皮擦 (Eraser)**：绘制透明（清除像素）。
3. **直线 (Line)**：
* 实时预览线条轨迹。
* Shift 键锁定：水平、垂直、45度。


4. **矩形 (Rect) / 圆形 (Circle)**：
* 模式：轮廓 (Stroke)、填充 (Fill)、轮廓+填充。
* Shift 键锁定：正方形/正圆。


5. **油漆桶 (Bucket Fill)**：
* 算法：4-连通泛洪填充 (Flood Fill)。


6. **选择工具 (Select)**：
* 功能：框选矩形区域。
* 移动：鼠标拖拽选区内容。
* **缩放（重点）**：拖拽选区边缘手柄进行缩放。
* 算法：**最近邻插值 (Nearest Neighbor)**，确保像素边缘清晰，不产生模糊/灰阶。





### 3.2 文本系统 (Text System) - *关键逻辑*

* **输入模式**：点击工具栏“T”图标，在属性栏输入文字，点击画布放置。
* **字体支持**：
* 下拉框列出系统字体。
* 按钮“导入字体”：选择本地 `.ttf/.otf` 文件加载到内存。


* **渲染逻辑 (由 Q2 确认)**：
* **高度**：由用户设置的字号决定 (px)。
* **宽度处理**：
* **全角字符 (中文/日文等)**：宽度 ≈ 字号 (保持原比例)。
* **半角字符 (ASCII 英文/数字/符号)**：**强制挤压 (Squeeze)**。通过 `QTransform` 将字符横向缩放 50%，使其宽度为字号的一半。




* **二值化**：渲染时关闭抗锯齿 (No Antialiasing)，或设定阈值将灰度转为纯黑白。
* **编辑状态**：
* 文本在“确认”前是浮动对象 (Floating Object)，可随意拖拽移动、修改内容。
* 点击“回车”或切换工具后，文本**栅格化** (Rasterize) 并合并到当前图层，之后不可再作为文本编辑。



### 3.3 图层管理

* **混合模式**：
* 图层背景默认为**透明**。
* 黑色像素为**不透明**。
* 上层遮挡下层。


* **操作**：
* 新建、删除、复制、上移、下移。
* **可见性**：小眼睛图标控制显示/隐藏。
* **锁定**：锁定后不可编辑。



## 4. 数据处理与导出 (Export System)

### 4.1 导出前预处理

1. **图层合并**：将所有**可见**图层按照层级从下到上进行叠加运算，生成最终的二维 0/1 矩阵。
2. **反色处理**：
* 如果用户勾选“导出反色”：`Bit = !Bit`。
* 默认：黑=1, 白=0。反色后：黑=0, 白=1。



### 4.2 数据格式化规则 (由 Q1 确认)

* **规则 A：字节对齐 (Byte Padding)**
* 当行宽/列高不是 8 的倍数时，必须补齐 `0` 到下一个完整的字节。
* *示例*：宽度 104 像素 -> 104 bits -> 13 bytes。高度 212 像素 -> 212 bits -> 26.5 bytes -> 导出 **27 bytes**（按行扫描时）。最后 4 bit 补 0。


* **规则 B：取模方式 (Scanning)**
1. **水平扫描 (Horizontal / Row-major)**:
* 从左到右取 8 个点组成一个字节，直到行尾（补齐），然后换行。


2. **垂直扫描 (Vertical / Column-major / Page mode)**:
* 常用于 OLED (SSD1306)。
* 将画布分为高度为 8 的“页 (Page)”。
* 从左到右，先取第 0 页的第一列 8 个点（作为1个字节），再取第 2 列... 直到宽度的尽头。然后进入第 1 页。




* **规则 C：位序 (Bit Order)**
1. **MSB First** (Most Significant Bit)：像素 0 对应 `0x80` (10000000)。
2. **LSB First** (Least Significant Bit)：像素 0 对应 `0x01` (00000001)。



### 4.3 导出界面与预览 (由 Q4 确认)

* **设置项**：
* 文件名输入。
* 取模方式 (水平/垂直)。
* 位序 (MSB/LSB)。
* 数据格式 (Hex C Array / Bin)。
* 复选框：反色。


* **实时预览区 (Preview Area)**：
* **逻辑**：根据当前选中的“取模方式”和“位序”，将合并后的数据流**反向解析**回图像显示。
* **目的**：如果预览图是混乱的噪点，用户可直观判断取模参数设置错误。



### 4.4 文件输出

1. **C Header (.h)**:
```c
// File: image_data.h
// Width: 104, Height: 212
// Format: Vertical, MSB First
const unsigned char image_data[] = {
    0x00, 0xFF, 0x12, ... // Hex format
};

```


2. **Binary (.bin)**: 纯二进制数据，无文件头。
3. **Image (.png)**: 标准 PNG 图片。
4. **Project File (.json)** (由 Q3 确认):
* 保存画布尺寸。
* 保存每个图层的 Base64 编码数据。
* 保存未栅格化的文本对象属性（如果支持）。



---

## 5. 项目里程碑

1. **Phase 1**: 搭建 PyQt6 框架，实现画布绘制、缩放、网格线。
2. **Phase 2**: 实现基本绘图工具（画笔、几何图形、填充）。
3. **Phase 3**: 实现图层系统和数据结构。
4. **Phase 4**: 实现文本工具（含自定义字体加载和 50% 宽度挤压算法）。
5. **Phase 5**: 实现导出算法（水平/垂直扫描、字节对齐）及预览功能。
6. **Phase 6**: 调试与打包。
